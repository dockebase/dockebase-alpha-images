services:
  dockebase-api:
    image: ghcr.io/dockebase/dockebase-alpha-images/api:latest
    container_name: dockebase-api
    volumes:
      # Host bind mount with SAME PATH inside and outside container
      # Required for stack bind mounts to work (Docker socket runs on host)
      - /opt/dockebase/data:/opt/dockebase/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - NODE_ENV=production
      - BETTER_AUTH_SECRET=${AUTH_SECRET}
      - BETTER_AUTH_URL=${BASE_URL}
      - DOCKEBASE_INSTANCE_URL=${BASE_URL}
      - FRONTEND_URL=${BASE_URL}
      - DOCKEBASE_INSTANCE_SECRET=${DOCKEBASE_INSTANCE_SECRET}
      - CADDY_ADMIN_URL=http://dockebase-caddy:2019
      - TRAEFIK_API_URL=http://dockebase-traefik:8080
      - ACME_EMAIL=${ACME_EMAIL}
      # Proxy initialization (read at startup)
      - DOCKEBASE_INIT_DOMAIN=${DOMAIN}
      - DOCKEBASE_INIT_EMAIL=${ACME_EMAIL}
      - DOCKEBASE_INIT_PROVIDER=${PROXY_PROVIDER}
      # Disable Docker Compose Bake (buildx) for classic build
      - COMPOSE_BAKE=0
      # Override default data paths to match host bind mount
      - STACKS_PATH=/opt/dockebase/data/stacks
      - DATABASE_PATH=/opt/dockebase/data/dockebase.db
    restart: unless-stopped
    networks:
      - dockebase-internal

  dockebase-ui:
    image: ghcr.io/dockebase/dockebase-alpha-images/ui:latest
    container_name: dockebase-ui
    ports:
      - "9000:80"  # Fallback HTTP access when proxy is disabled
    restart: unless-stopped
    networks:
      - dockebase-internal

networks:
  dockebase-internal:
    name: dockebase-internal
    external: true
